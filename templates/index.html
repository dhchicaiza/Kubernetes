<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CRUD Registrar Personas</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .container { max-width: 800px; margin: auto; }
        h2 { border-bottom: 2px solid #ccc; padding-bottom: 5px; }
        form { margin-bottom: 30px; padding: 20px; border: 1px solid #eee; border-radius: 5px; }
        input[type="text"], textarea { width: 100%; padding: 8px; margin-bottom: 10px; box-sizing: border-box; }
        button { background-color: #007bff; color: white; padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background-color: #0056b3; }
        .btn-edit { background-color: #ffc107; padding: 5px 10px; margin-right: 5px; }
        .btn-edit:hover { background-color: #e0a800; }
        .btn-delete { background-color: #dc3545; padding: 5px 10px; }
        .btn-delete:hover { background-color: #c82333; }
        .btn-cancel { background-color: #6c757d; margin-left: 10px; }
        .btn-cancel:hover { background-color: #5a6268; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; }
        .hidden { display: none; }
    </style>
</head>
<body>
    <div class="container">
        <h1>CRUD Registrar Personas</h1>

        <h2 id="formTitle">Crear Nuevo Registro</h2>
        <form id="createForm">
            <input type="hidden" id="editId" value="">

            <label for="nombre">Nombre:</label>
            <input type="text" id="nombre" required>

            <label for="mensaje">Mensaje:</label>
            <textarea id="mensaje" required></textarea>

            <button type="submit" id="submitBtn">Guardar Registro</button>
            <button type="button" id="cancelBtn" class="btn-cancel hidden">Cancelar</button>
            <p id="statusMessage" style="margin-top: 10px;"></p>
        </form>

        <h2>Listado de Registros</h2>
        <table>
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Nombre</th>
                    <th>Mensaje</th>
                    <th>Fecha</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody id="registrosTableBody">
            </tbody>
        </table>
    </div>

    <script>
        const tableBody = document.getElementById('registrosTableBody');
        const form = document.getElementById('createForm');
        const statusMessage = document.getElementById('statusMessage');
        const formTitle = document.getElementById('formTitle');
        const editIdInput = document.getElementById('editId');
        const nombreInput = document.getElementById('nombre');
        const mensajeInput = document.getElementById('mensaje');
        const submitBtn = document.getElementById('submitBtn');
        const cancelBtn = document.getElementById('cancelBtn');

        // Función para cargar y mostrar los registros
        function loadRecords() {
            fetch('/api/registros')
                .then(response => response.json())
                .then(data => {
                    tableBody.innerHTML = '';
                    if (data.error) {
                        tableBody.innerHTML = `<tr><td colspan="5" style="color:red;">Error de BD: ${data.details}</td></tr>`;
                        return;
                    }
                    data.forEach(record => {
                        const row = tableBody.insertRow();
                        row.insertCell().textContent = record.id;
                        row.insertCell().textContent = record.nombre;
                        row.insertCell().textContent = record.mensaje;
                        row.insertCell().textContent = record.fecha;

                        // Celda de acciones con botones
                        const actionsCell = row.insertCell();
                        const editBtn = document.createElement('button');
                        editBtn.textContent = 'Editar';
                        editBtn.className = 'btn-edit';
                        editBtn.onclick = () => editRecord(record.id);

                        const deleteBtn = document.createElement('button');
                        deleteBtn.textContent = 'Eliminar';
                        deleteBtn.className = 'btn-delete';
                        deleteBtn.onclick = () => deleteRecord(record.id);

                        actionsCell.appendChild(editBtn);
                        actionsCell.appendChild(deleteBtn);
                    });
                })
                .catch(error => {
                    console.error('Error al cargar registros:', error);
                    tableBody.innerHTML = `<tr><td colspan="5" style="color:red;">Error de conexión con la API.</td></tr>`;
                });
        }

        // Función para editar un registro
        function editRecord(id) {
            fetch(`/api/registros/${id}`)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        alert('Error al cargar el registro: ' + data.error);
                        return;
                    }

                    // Cambiar el formulario a modo edición
                    formTitle.textContent = 'Editar Registro';
                    editIdInput.value = id;
                    nombreInput.value = data.nombre;
                    mensajeInput.value = data.mensaje;
                    submitBtn.textContent = 'Actualizar Registro';
                    cancelBtn.classList.remove('hidden');

                    // Scroll al formulario
                    form.scrollIntoView({ behavior: 'smooth' });
                })
                .catch(error => {
                    console.error('Error al obtener el registro:', error);
                    alert('Error al cargar el registro para editar');
                });
        }

        // Función para eliminar un registro
        function deleteRecord(id) {
            if (!confirm('¿Estás seguro de que deseas eliminar este registro?')) {
                return;
            }

            fetch(`/api/registros/${id}`, {
                method: 'DELETE'
            })
            .then(response => response.json())
            .then(data => {
                if (data.status) {
                    statusMessage.textContent = data.status;
                    statusMessage.style.color = 'green';
                    loadRecords();
                } else {
                    statusMessage.textContent = `Error: ${data.error}`;
                    statusMessage.style.color = 'red';
                }
            })
            .catch(error => {
                console.error('Error al eliminar registro:', error);
                statusMessage.textContent = 'Error al eliminar el registro.';
                statusMessage.style.color = 'red';
            });
        }

        // Función para resetear el formulario a modo creación
        function resetForm() {
            formTitle.textContent = 'Crear Nuevo Registro';
            editIdInput.value = '';
            nombreInput.value = '';
            mensajeInput.value = '';
            submitBtn.textContent = 'Guardar Registro';
            cancelBtn.classList.add('hidden');
            statusMessage.textContent = '';
        }

        // Manejador del botón cancelar
        cancelBtn.addEventListener('click', resetForm);

        // Manejador del formulario para crear o actualizar
        form.addEventListener('submit', function(e) {
            e.preventDefault();

            const nombre = nombreInput.value;
            const mensaje = mensajeInput.value;
            const editId = editIdInput.value;

            // Si hay un ID, es una actualización, si no, es una creación
            const url = editId ? `/api/registros/${editId}` : '/api/crear';
            const method = editId ? 'PUT' : 'POST';

            fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ nombre, mensaje })
            })
            .then(response => response.json())
            .then(data => {
                statusMessage.textContent = data.status || `Error: ${data.error}`;
                statusMessage.style.color = data.status ? 'green' : 'red';

                if (data.status) {
                    resetForm();
                    loadRecords();
                }
            })
            .catch(error => {
                statusMessage.textContent = 'Error al enviar datos.';
                statusMessage.style.color = 'red';
                console.error('Error en la operación:', error);
            });
        });

        // Cargar registros al iniciar la página
        loadRecords();
        // Opcional: recargar la lista cada 10 segundos
        setInterval(loadRecords, 10000);

    </script>
</body>
</html>